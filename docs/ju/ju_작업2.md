# 레시피 추천 서비스 프롬프트 고도화 작업 계획

## 1. `_build_recipe_prompt` 메서드 시그니처 수정
- [x] `diseases: Optional[List[str]] = None` 인자 추가
- [x] `allergies: Optional[List[str]] = None` 인자 추가
- [x] `get_recipe_recommendations`에서 호출 시 해당 정보 전달하도록 수정

## 2. 안전 계층(Safety Hierarchy) 프롬프트 로직 구현 (`health_first` 모드)
- [x] **Level 1: 알레르기 절대 배제 (Critical)**
    - [x] 사용자의 알레르기 유발 재료가 포함된 경우 0.01%도 남기지 않고 제거하거나 전면 교체하도록 지시.
- [x] **Level 2: 질병 관리 (Strict Constraint)**
    - [x] 질병(예: 고지혈증, 당뇨 등)에 치명적인 재료(내장류, 설탕 등)는 조리법 변경이 아닌 '식재료 완전 대체'를 수행하도록 지시.
    - [x] 예시 추가: "기름 뺀 대창(X) -> 새송이 버섯(O)"
- [x] **Level 3: 식감 및 다양성 (Creative Substitution) & 맛의 조화 (Culinary Harmony)**
    - [x] '닭가슴살', '곤약' 등의 단순 반복 추천 지양.
    - [x] 원래 재료의 **식감(Texture)**과 **풍미**를 살릴 수 있는 대체재(버섯, 해산물, 두부면, 콩고기 등) 활용 유도.
    - [x] **[추가] 괴식 방지 및 현실성 확보**:
        - [x] 대체 재료가 원래의 양념이나 조리법과 **요리적으로 어울리는지** 반드시 고려.
        - [x] "끔찍한 혼종(괴식)"이 되지 않도록, **실제로 존재하고 검증된 '맛있는 건강 레시피'** 데이터에 기반하여 추천.
        - [x] 맛이 보장되지 않는 무리한 대체보다는, 조리법(튀김→구이)을 바꾸거나 부재료를 풍성하게 하는 방향 권장.

## 3. 사용자 선택 존중 로직 구현 (`proceed` 모드)
- [x] **타인을 위한 요리 가능성 고려**
    - [x] "그대로 진행해줘" 선택 시, 알레르기나 질병 경고를 무시하고 사용자가 요청한 **원래 맛과 재료**를 그대로 유지하도록 강력한 지시 추가.

## 4. 프롬프트 최적화 및 성능 고려 (Latency Optimization & Conflict Prevention)
- [x] **지시사항 간소화 (Token Efficiency)**
    - [x] 장황한 서술형 문장을 명료한 **개조식(Bullet points)**으로 변환하여 토큰 수 절약 및 LLM 해석 속도 향상.
    - [x] 불필요한 수식어를 제거하고 핵심 제약 조건 위주로 구성.
- [x] **Context 분기 처리**
    - [x] `health_first` 모드가 아닐 경우(예: `proceed`), 안전 관련 복잡한 지침 텍스트를 아예 프롬프트에서 제외하여 처리량 감소.
- [x] **기존 프롬프트와의 충돌 방지 (Structure Cleanup)**
    - [x] 기존 `SystemMessage`와 새로 추가되는 `safety_directive` 간의 논리적 모순이 없도록 문맥 정리.
    - [x] 중복된 지시는 제거하여 LLM이 혼란을 겪지 않도록(Hallucination 방지) 구조 단일화.

## 5. 상세 레시피 생성 시 안전성 유지 (Context Persistence)
- [x] **상세보기 프롬프트에 제약 조건 재주입 (Safety Re-injection)**
    - [x] `get_recipe_detail` 및 `generate_custom_cooking_steps` 호출 시에도 사용자의 **질병 및 알레르기 정보**를 반드시 프롬프트에 다시 포함.
    - [x] 추천 단계에서 제외된 재료가 상세 조리법(재료 목록, 육수, 소스 팁 등)에서 **부활하지 않도록** 강력한 금지 지침 추가.
    - [x] "이 레시피는 [알레르기/질병] 사용자를 위한 것이므로 [재료]는 절대 사용 금지" 명시.

## 6. 검증 및 테스트
- [ ] 고지혈증 사용자가 '대창' 요리 요청 시 -> 대창이 빠지고 식감이 유사한 대체재(버섯/관자 등)로 변경되는지 확인.
- [ ] 알레르기 사용자가 해당 재료 요청 시 -> 완벽하게 배제되는지 확인.
- [ ] '그대로 진행' 선택 시 -> 경고 무시하고 원래 레시피가 나오는지 확인.